# File YAML untuk konfigurasi workflow CI/CD aplikasi Karsajobs backend pada CircleCI
# untuk assignment Dicoding 2 - Membangun Arsitektur Microservices dengan Kubernetes
# Nama siswa: Lonard Steven - Jakarta

version: 2.1              # Menetapkan versi YML dari file konfigurasi YML

jobs:                                                                       # Definisi job yang akan dilakukan pada CircleCI
  lint-dockerfile:                                                          # Job 1 - lint-dockerfile: Menginstal Hadolint dan menggunakannya pada Dockerfile backend
    docker:
      - image: cimg/base:2023.11
    steps:
      - checkout                                                            # Lakukan checkout step
      - setup_remote_docker:                                                # Atur entity Docker yang dijalankan secara remote (dengan layer caching diaktifkan)
          docker_layer_caching: true
      - run: docker run --rm -i hadolint/hadolint < Dockerfile              # Pakai Hadolint untuk Dockerfile di repositori terkait
  test-app:                                                                 # Job 2 - test-app: Menguji app backend
    docker:
      - image: golang:latest
    steps:
      - run: cd ..
      - run: go test -v -short --count=1 $(go list ./...)
  build-app-karsajobs:                                                      # Job 3 - build-app-karsajobs: Menjalankan file script untuk build dan push image
    docker:
      - image: cimg/base:2023.11
    steps:
      - run: sh build_push_image_karsajobs.sh

workflows:                                # Alur kerja/workflow dari proses CI/CD yang dilakukan CircleCI, yakni:
  karsajobs-cicd:
    jobs:
      - lint-dockerfile                   # Melakukan job 1 (lint-dockerfile) pertama-tama,
      - test-app:                         # Melakukan job 2 (test-app) setelah job lint-dockerfile tuntas & berhasil dilakukan, dan
          requires:
            - lint-dockerfile
      - build-app-karsajobs:              # Melakukan job 3 (build-app-karsajobs) setelah job lint-dockerfile & test-app selesai dilakukan (dan berhasil)
          requires:
            - lint-dockerfile
            - test-app